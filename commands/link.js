const {
        SlashCommandBuilder,
            ModalBuilder,
                TextInputBuilder,
                    TextInputStyle,
                        ActionRowBuilder,
                            InteractionType
                            } = require('discord.js');
                            const axios = require('axios');
                            const { db } = require('../database');
                            const { API_URL_USER_CREATE, API_KEY, LOG_CHANNEL_ID } = require('../config');
                            const { logDebug, logError } = require('../utils/logger');
                            const { isUserAlreadyLinked } = require('../utils/userChecks');

                            module.exports = {
                                data: new SlashCommandBuilder()
                                        .setName('link')
                                                .setDescription('Verlinke deinen existierenden Hosting-Account'),

                                                    async execute(interaction, client) {
                                                            if (interaction.isChatInputCommand()) {
                                                                        const userId = interaction.user.id;
                                                                                    const guildId = interaction.guildId;

                                                                                                if (await isUserAlreadyLinked(userId, guildId)) {
                                                                                                                return await interaction.reply({
                                                                                                                                    content: '‚ö†Ô∏è Du hast bereits einen Account registriert oder verlinkt.',
                                                                                                                                                        ephemeral: true
                                                                                                                                                                        });
                                                                                                                                                                                    }

                                                                                                                                                                                                const modal = new ModalBuilder()
                                                                                                                                                                                                                .setCustomId('link_modal')
                                                                                                                                                                                                                                .setTitle('Bestehenden Account verlinken');

                                                                                                                                                                                                                                            modal.addComponents(
                                                                                                                                                                                                                                                            new ActionRowBuilder().addComponents(
                                                                                                                                                                                                                                                                                new TextInputBuilder()
                                                                                                                                                                                                                                                                                                        .setCustomId('link_username')
                                                                                                                                                                                                                                                                                                                                .setLabel('Benutzername')
                                                                                                                                                                                                                                                                                                                                                        .setStyle(TextInputStyle.Short)
                                                                                                                                                                                                                                                                                                                                                                                .setRequired(true)
                                                                                                                                                                                                                                                                                                                                                                                                ),
                                                                                                                                                                                                                                                                                                                                                                                                                new ActionRowBuilder().addComponents(
                                                                                                                                                                                                                                                                                                                                                                                                                                    new TextInputBuilder()
                                                                                                                                                                                                                                                                                                                                                                                                                                                            .setCustomId('link_email')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .setLabel('E-Mail-Adresse')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .setStyle(TextInputStyle.Short)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .setRequired(true)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await interaction.showModal(modal);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else if (interaction.isModalSubmit() && interaction.customId === 'link_modal') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await interaction.deferReply({ ephemeral: true });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const username = interaction.fields.getTextInputValue('link_username');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const email = interaction.fields.getTextInputValue('link_email');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const userId = interaction.user.id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const guildId = interaction.guildId;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const url = `${API_URL_USER_CREATE}?filter%5Bemail%5D=${encodeURIComponent(email)}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const response = await axios.get(url, {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            headers: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'Authorization': `Bearer ${API_KEY}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            'Accept': 'Application/vnd.pterodactyl.v1+json',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'Content-Type': 'application/json'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const users = response.data.data;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const user = users.find(u =>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            u.attributes.email === email &&
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                u.attributes.username === username
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!user) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return await interaction.editReply({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            content: '‚ùå Kein Benutzer mit diesen Daten gefunden.'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const pelicanUserId = user.attributes.id;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                db.run(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    'INSERT OR REPLACE INTO user_registrations (discord_user_id, guild_id, email, username, pelican_user_id) VALUES (?, ?, ?, ?, ?)',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        [userId, guildId, email, username, pelicanUserId]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await interaction.editReply({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            content: '‚úÖ Dein Account wurde erfolgreich verlinkt.'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const logChannel = await client.channels.fetch(LOG_CHANNEL_ID).catch(() => null);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (logChannel?.isTextBased()) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await logChannel.send(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        `üîó **Account verlinkt:**\nüë§ ${interaction.user.tag} (\`${userId}\`)\nüìß ${email}\nüîê Benutzername: ${username}`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        logError('Fehler bei Verlinkung:', error.response?.data || error.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await interaction.editReply({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            content: '‚ùå Fehler bei der API-Anfrage oder Verarbeitung.'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    };
